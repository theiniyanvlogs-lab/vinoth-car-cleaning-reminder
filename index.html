<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vinoth Car Cleaning ‚Äì Payments</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f6f8;padding:15px}
h2{text-align:center}
.box{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
button{border:none;font-size:15px;cursor:pointer}
.save{background:#007bff;color:#fff}
.export{background:#198754;color:#fff}
#lockScreen{
  max-width:360px;
  margin:80px auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
  text-align:center
}
</style>
</head>

<body>

<!-- üîí PASSWORD SCREEN -->
<div id="lockScreen">
  <h3>üîí Enter Password</h3>
  <input type="password" id="passwordInput">
  <button class="save" type="button" onclick="unlock()">Unlock</button>
  <p id="err" style="color:red"></p>
</div>

<!-- üîì APP -->
<div id="app" style="display:none">

<h2>üöó Vinoth Car Cleaning ‚Äì Payments</h2>

<div class="box">
<h3>Add Customer</h3>

<input id="name" placeholder="Owner Name (optional)">
<input id="flat" placeholder="Flat Number (optional)">
<input id="car" placeholder="Car Number (optional)">
<input id="mobile" placeholder="Mobile Number">

<select id="month">
<option value="">Select Month</option>
<option>January</option><option>February</option><option>March</option>
<option>April</option><option>May</option><option>June</option>
<option>July</option><option>August</option><option>September</option>
<option>October</option><option>November</option><option>December</option>
</select>

<select id="year">
<option value="">Select Year</option>
<option>2024</option><option>2025</option><option>2026</option>
</select>

<input id="amount" type="number" value="600">

<select id="status">
<option value="pending">Pending</option>
<option value="paid">Paid</option>
</select>

<button class="save" type="button" onclick="saveData()">Save</button>
</div>

<div class="box">
<button class="export" type="button" onclick="exportPendingPDF()">
Export Pending (PDF)
</button>
</div>

</div>

<!-- üî• Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- üìÑ PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* üîê PASSWORD */
const PASSWORDSS = ["vinoth600","clean@247"];
const VERSION = "v11";

if(localStorage.getItem("unlock") === VERSION){
  lockScreen.style.display="none";
  app.style.display="block";
}

function unlock(){
  if(PASSWORDS.includes(passwordInput.value)){
    localStorage.setItem("unlock", VERSION);
    lockScreen.style.display="none";
    app.style.display="block";
  } else {
    err.innerText = "Wrong password";
  }
}

/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCWbIwSjYSHrMYvvKK8HByqcDy6wUj7pu8",
  authDomain: "vinoth-car-cleaning-reminder.firebaseapp.com",
  projectId: "vinoth-car-cleaning-reminder"
});

const db = firebase.firestore();
const ref = db.collection("carPayments");

/* üíæ SAVE DATA (FIXED) */
async function saveData(){
  if(
    mobile.value.trim().length < 10 ||
    (!flat.value.trim() && !car.value.trim()) ||
    !month.value ||
    !year.value
  ){
    alert("Mobile + Flat or Car + Month + Year required");
    return;
  }

  const btn = event.target;
  btn.disabled = true;
  btn.innerText = "Saving...";

  try{
    await ref.add({
      name: name.value.trim(),
      flat: flat.value.trim(),
      car: car.value.trim(),
      mobile: mobile.value.trim(),
      month: month.value + " " + year.value,
      amount: Number(amount.value),
      status: status.value,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // ‚úÖ clear fields AFTER save
    name.value = "";
    flat.value = "";
    car.value = "";
    mobile.value = "";
    month.value = "";
    year.value = "";
    amount.value = 600;
    status.value = "pending";

    alert("Saved successfully ‚úÖ");

  } catch(e){
    alert("Save failed ‚ùå");
    console.error(e);
  }

  btn.disabled = false;
  btn.innerText = "Save";
}

/* üìÑ EXPORT PENDING PDF (LIVE QUERY) */
async function exportPendingPDF(){
  const snap = await ref.where("status","==","pending").get();
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.text("Vinoth Car Cleaning ‚Äì Pending Payments",10,10);
  let y = 20;
  let i = 1;

  if(snap.empty){
    pdf.text("No pending records available.",10,y);
  } else {
    snap.forEach(doc=>{
      const p = doc.data();
      pdf.text(
        `${i}. ${p.name || "Owner"} | Flat:${p.flat || "-"} | Car:${p.car || "-"} | Mobile:${p.mobile} | ${p.month} | ‚Çπ${p.amount}`,
        10,y
      );
      y += 8;
      i++;
      if(y > 280){ pdf.addPage(); y = 20; }
    });
  }

  pdf.save("Pending_Payments.pdf");
}
</script>

</body>
</html>
