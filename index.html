<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vinoth Car Cleaning â€“ Payments</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f6f8;padding:15px}
h2{text-align:center}
.form,.list,.summary{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px}
input,select{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
button{padding:10px;width:100%;margin-top:8px;border:none;border-radius:6px;font-size:14px;cursor:pointer}
.add{background:#007bff;color:#fff}
.pending{background:#dc3545;color:#fff}
.paid{background:#28a745;color:#fff}
.whatsapp{background:#25D366;color:#fff}
.edit{background:#ffc107}
.delete{background:#6c757d;color:#fff}
.card{border-bottom:1px solid #ddd;padding:10px 0}
small{color:#555}
#lockScreen{max-width:380px;margin:80px auto;padding:20px;background:#fff;border-radius:10px;
box-shadow:0 4px 10px rgba(0,0,0,0.1);text-align:center}
</style>
</head>
<body>

<!-- ðŸ”’ PASSWORD SCREEN -->
<div id="lockScreen">
  <h3>ðŸ”’ Enter Password</h3>
  <input type="password" id="passwordInput" placeholder="Enter password">
  <button class="add" onclick="unlockApp()">Unlock</button>
  <p id="errorText" style="color:red"></p>
</div>

<!-- ðŸ”“ APP CONTENT -->
<div id="appContent" style="display:none">

<h2>ðŸš— Vinoth Car Cleaning â€“ Payments</h2>

<div class="summary">
<b>Total Pending Amount:</b> â‚¹<span id="totalPending">0</span>
</div>

<div class="form">
<h3>Add / Edit Customer</h3>

<input id="ownerName" placeholder="Owner Name (optional)">
<input id="flatNo" placeholder="Flat Number (optional)">
<input id="carNo" placeholder="Car Number (optional)">
<input id="mobile" placeholder="WhatsApp Number (91XXXXXXXXXX)">

<select id="month">
  <option value="">Select Month</option>
  <option>January</option><option>February</option><option>March</option>
  <option>April</option><option>May</option><option>June</option>
  <option>July</option><option>August</option><option>September</option>
  <option>October</option><option>November</option><option>December</option>
</select>

<select id="year">
  <option value="">Select Year</option>
  <option>2024</option>
  <option>2025</option>
  <option>2026</option>
</select>

<input id="amount" type="number" value="600">

<select id="status">
  <option value="pending">Pending</option>
  <option value="paid">Paid</option>
</select>

<button class="add" onclick="addOrUpdate()">Save</button>
</div>

<!-- ðŸ” SEARCH -->
<div class="form">
<h3>Search</h3>
<input id="filterText" placeholder="Enter Flat or Car Number (Ex: B302)">
<button class="add" onclick="applySearch()">Search</button>
<button class="delete" onclick="clearSearch()">Clear</button>
</div>

<div class="list">
<h3>Paid / Pending List</h3>
<div id="paymentList"></div>
</div>

</div>

<!-- ðŸ”¥ FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ðŸ” PASSWORD */
const ALLOWED_PASSWORDS=["vinoth600","clean@247"];
const PASSWORD_VERSION="v4";

if(localStorage.getItem("appUnlocked")===PASSWORD_VERSION){
  lockScreen.style.display="none";
  appContent.style.display="block";
}
function unlockApp(){
  if(ALLOWED_PASSWORDS.includes(passwordInput.value)){
    localStorage.setItem("appUnlocked",PASSWORD_VERSION);
    lockScreen.style.display="none";
    appContent.style.display="block";
  } else errorText.innerText="Wrong password";
}

/* ðŸ”¥ FIREBASE CONFIG (REPLACE VALUES) */
const firebaseConfig={
  apiKey:"YOUR_API_KEY",
  authDomain:"YOUR_PROJECT.firebaseapp.com",
  projectId:"YOUR_PROJECT_ID",
  storageBucket:"YOUR_PROJECT.appspot.com",
  messagingSenderId:"XXXX",
  appId:"XXXX"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const ref=db.collection("carPayments");

/* ðŸ“¦ DATA */
let payments=[];
let editId=null;
let activeFilter="";

/* âž• ADD / âœï¸ EDIT */
async function addOrUpdate(){
  const data={
    name:ownerName.value.trim(),
    flat:flatNo.value.trim(),
    car:carNo.value.trim(),
    mobile:mobile.value.trim(),
    month:month.value+" "+year.value,
    amount:Number(amount.value),
    status:status.value
  };

  if(!data.mobile || !month.value || !year.value || (!data.flat && !data.car)){
    alert("Please enter Mobile and at least Flat or Car Number");
    return;
  }

  if(editId){
    await ref.doc(editId).set(data);
    editId=null;
  } else {
    await ref.add(data);
  }
  resetForm(); // âœ… clear for next entry
}

/* ðŸ” RESET FORM */
function resetForm(){
  ownerName.value=flatNo.value=carNo.value=mobile.value="";
  month.value=year.value="";
  amount.value=600;
  status.value="pending";
}

/* ðŸŸ¢ MARK PAID */
function markPaid(id){
  ref.doc(id).update({status:"paid"});
}

/* âœï¸ EDIT */
function editEntry(p){
  ownerName.value=p.name||"";
  flatNo.value=p.flat||"";
  carNo.value=p.car||"";
  mobile.value=p.mobile;
  const m=p.month.split(" ");
  month.value=m[0]; year.value=m[1];
  amount.value=p.amount;
  status.value=p.status;
  editId=p.id;
}

/* ðŸ—‘ï¸ DELETE */
function deleteEntry(id){
  if(confirm("Delete this entry?")){
    ref.doc(id).delete();
  }
}

/* ðŸ“² WHATSAPP */
function sendReminder(p){
  const msg=`Hi Sir/Madam,
Car cleaning charge of â‚¹${p.amount} for ${p.month} is pending.
Kindly make the payment when convenient.

Thank you,
Vinoth
+91 7358461020
Madha Kovil Street, Nolambur`;
  window.open("https://wa.me/"+p.mobile+"?text="+encodeURIComponent(msg),"_blank");
}

/* ðŸ” SEARCH */
function applySearch(){
  activeFilter=document.getElementById("filterText").value;
  render();
}
function clearSearch(){
  filterText.value="";
  activeFilter="";
  render();
}

/* ðŸ”„ LOAD FROM FIRESTORE (ONLY PLACE RENDER IS CALLED) */
function loadData(){
  ref.onSnapshot(snapshot=>{
    payments=[];
    snapshot.forEach(doc=>{
      payments.push({...doc.data(),id:doc.id});
    });
    render();
  });
}

/* ðŸ–¥ï¸ RENDER */
function render(){
  paymentList.innerHTML="";
  let total=0;

  const f=(activeFilter||"").toLowerCase().replace(/[\s-]/g,"");

  payments.forEach(p=>{
    const flat=(p.flat||"").toLowerCase().replace(/[\s-]/g,"");
    const car=(p.car||"").toLowerCase().replace(/[\s-]/g,"");

    if(f && !(flat.includes(f)||car.includes(f))) return;

    if(p.status==="pending") total+=Number(p.amount);

    paymentList.innerHTML+=`
    <div class="card">
      <b>${p.name||"Owner"}</b>
      ${p.flat?`(Flat ${p.flat})`:""}<br>
      ${p.car?`ðŸš— ${p.car}<br>`:""}
      ${p.month} â€“ â‚¹${p.amount}
      <small> â€¢ ${p.status.toUpperCase()}</small><br>

      ${p.status==="pending"
        ? `<button class="pending" onclick="markPaid('${p.id}')">Mark Paid</button>
           <button class="whatsapp" onclick='sendReminder(${JSON.stringify(p)})'>WhatsApp</button>`
        : `<button class="paid">Paid</button>`}

      <button class="edit" onclick='editEntry(${JSON.stringify(p)})'>Edit</button>
      <button class="delete" onclick="deleteEntry('${p.id}')">Delete</button>
    </div>`;
  });

  totalPending.innerText=total;
}

/* ðŸš€ START */
loadData();
</script>

</body>
</html>
